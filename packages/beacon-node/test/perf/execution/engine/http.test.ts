import {itBench, setBenchOpts} from "@dapplion/benchmark";
import {fromHexString} from "@chainsafe/ssz";
import {bellatrix} from "@lodestar/types";
import {serializeExecutionPayload} from "../../../../src/execution/engine/http.js";

describe("prepare notifyNewPayload execution api", function () {
  setBenchOpts({
    minMs: 30 * 1000,
  });

  // sample data from block https://etherscan.io/block/15426554
  const seedExecutionPayload: bellatrix.ExecutionPayload = {
    parentHash: fromHexString("0xabec4ca55115f746c9af9c6c49dd4baed47d12bf7f4b5aa2178353a97b2cb3c0"),
    feeRecipient: fromHexString("0xea674fdde714fd979de3edf0f56aa9716b898ec8"),
    stateRoot: fromHexString("0xca0f917adaa25411e413ed45657f71e59c1ecceff252581111211c95b0808250"),
    receiptsRoot: fromHexString("0xca0f917adaa25411e413ed45657f71e59c1ecceff252581111211c95b0808250"),
    logsBloom: fromHexString("0xca0f917adaa25411e413ed45657f71e59c1ecceff252581111211c95b0808250"),
    prevRandao: fromHexString("0xca0f917adaa25411e413ed45657f71e59c1ecceff252581111211c95b0808250"),
    blockNumber: 15426554,
    gasLimit: 30000000,
    gasUsed: 29986534,
    timestamp: 1661647326,
    extraData: fromHexString("0xca0f917adaa25411e413ed45657f71e59c1ecceff252581111211c95b0808250"),
    baseFeePerGas: BigInt(3879647684),
    blockHash: fromHexString("0x8fac7b27f502be4674c60806f1c9d17a31d3b6fd0e41a1d4d3950dc42083b9e9"),
    transactions: [],
  };
  const testCases: {numTransaction: number}[] = [{numTransaction: 50}, {numTransaction: 200}, {numTransaction: 500}];

  // https://etherscan.io/getRawTx?tx=0xa662888a76bf5443b35ad7afe721df1d389452c3ff67d091c5bfcc82c6bf8c93
  const longTransactionRaw =
    "0x02f90d8f0182757a8084e73eb9c4830dcd50946af1a16fde7346e7729fa921ad2ddf6a462061e28710e913612b2a06b8830100eb63fa007c0f0000000020c0022e78d777b1ae00250100110036b00ba72291e1a028a1ed1c8ef34625aec17541b6147a40a3840c918263655e250100110034b00b9aa47ae25b2783903afe55eb5239e3f956e40586917143e541028f6f062305000f0000c0024a5e1775eabaa44073597b2bad443d94247ae9dd6011f43088fee1f90c99d6947a250d5630b4cf539739df2c5dacb4c659f2488dc0f89b944073597b2bad443d94247ae9dd6011f43088fee1f884a0000000000000000000000000000000000000000000000000000000000000000ca00000000000000000000000000000000000000000000000000000000000000006a00000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000008f902ee9406d5ca7c9accd15a87d4993a421b7e702bdbab20f902d6a00000000000000000000000000000000000000000000000000000000000000018a00000000000000000000000000000000000000000000000000000000000000015a06bbf63ccc812c3ad4bec82b4209118e1239e429c0ba7c2aca420e00287fa2015a00000000000000000000000000000000000000000000000000000000000000005a00000000000000000000000000000000000000000000000000000000000000010a00000000000000000000000000000000000000000000000000000000000000011a0000000000000000000000000000000000000000000000000000000000000000fa0673570b40957923f91074adc6d929e96d828357821580dfcfc19a79d47584673a00000000000000000000000000000000000000000000000000000000000000014a00000000000000000000000000000000000000000000000000000000000000009a048c9006f208d4f6cf227e4730dfe544cf2eeff8334e394e9de1f3f2cb75acb9ea0646c10ea1d84820d25b514afbd6086890d80fc04be5c33116b94d87602571bf2a00000000000000000000000000000000000000000000000000000000000000017a00000000000000000000000000000000000000000000000000000000000000016a022276b066aaf8823b47ad9a726cf5c887c34bc1f95cb7fb691505feaf37b651ea00000000000000000000000000000000000000000000000000000000000000013a0c5920b25b949a317774460f4688426873c377294e05b03c92a75c18cbaf8d20fa0f10f5ff192b7a421c93e0b2d9943cec9a025f2f322637e4e3698993cac725802a0000000000000000000000000000000000000000000000000000000000000000ea0000000000000000000000000000000000000000000000000000000000000000ba0b35c4ef2823a5898162229bf9b7bd0fa6e271cbacd6392ce75f4f21dcdb6aaeaa00000000000000000000000000000000000000000000000000000000000000012f87a945c69bee701ef814a2b6a3edd4b1652cb9cc5aa6ff863a09b9150af7c3323b8c50ec189fd5e3bc4a0c3fc0b29ee6455c0908b126f9224e2a00000000000000000000000000000000000000000000000000000000000000000a0cbf63849888a406c0999d26c5da8949fd657e815ea74c910d985806a022d154bf8dd94700000f7c2c71caab6b250ca85237117ff702ebbf8c6a00000000000000000000000000000000000000000000000000000000000000005a04c7effdacc3bdd7861cad6c961479041c6dcefbfd5de5719a24faa55c3429647a07632daf2db56f599bebec9b95be3ae6384387bf51313b8b770657d5f169071bba00000000000000000000000000000000000000000000000000000000000000006a00000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000003f8dd94c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2f8c6a0ee95043106783d47df4d80516cb734e9e9fc58d01a5e03f036a4132e2e232dbea05cf72deb59d00ef7d6871b28defbff744fb8eb5bd98716107a93a30d083edec9a0fb19a963956c9cb662dd3ae48988c4b90766df71ea130109840abe0a1b23dba8a07fbb273ff98653797a71f01afde56035ea1d107dcde0af7e4b0fae3339d5c835a009cbc8f78e3fedea2f19a850bf486ef9ee36315140916a317e8183dd01e6a8aaa0d131e80884daa48f970dee21d062eada563a8fd98f9c0bb455892926bed55568f8dd948ef34625aec17541b6147a40a3840c918263655ef8c6a0000000000000000000000000000000000000000000000000000000000000000ca00000000000000000000000000000000000000000000000000000000000000008a00000000000000000000000000000000000000000000000000000000000000006a00000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000009a0000000000000000000000000000000000000000000000000000000000000000af8dd9470041db5acdf2f8aa648a000fa4a87067abae105f8c6a006f6a925a824f89b03da1d5b8ef4dfed8872d1c2e9635224f595067f37fe988ca00000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000000000011a0000000000000000000000000000000000000000000000000000000000000000ba08bcd32d4e8a89569a7399b58359b04168a4412e3448ec0440e0b91bc796ce1e8a06319a58dab6b1361bdb0df6da38c744258c05249d95dbe92956a7e16ee790362f8dd94fe55eb5239e3f956e40586917143e541028f6f06f8c6a0000000000000000000000000000000000000000000000000000000000000000aa0000000000000000000000000000000000000000000000000000000000000000ca00000000000000000000000000000000000000000000000000000000000000008a00000000000000000000000000000000000000000000000000000000000000006a00000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000009f9012094ac0a75c270809b7af6cf02277a17c17e27074577f90108a0000000000000000000000000000000000000000000000000000000000000000ba00000000000000000000000000000000000000000000000000000000000000000a0b34209a263f6c38fe55f099e9e70f9d67e93982480ff3234a5e0108028ad164da00000000000000000000000000000000000000000000000000000000000000008a0000000000000000000000000000000000000000000000000000000000000000ca00000000000000000000000000000000000000000000000000000000000000006a00000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000005f901209470021e5eda64e68f035356ea3dce14ef87b6f105f90108a006f6a925a824f89b03da1d5b8ef4dfed8872d1c2e9635224f595067f37fe988ca00000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000000000011a0000000000000000000000000000000000000000000000000000000000000000ba08bcd32d4e8a89569a7399b58359b04168a4412e3448ec0440e0b91bc796ce1e8a06bbf63ccc812c3ad4bec82b4209118e1239e429c0ba7c2aca420e00287fa2015a0673570b40957923f91074adc6d929e96d828357821580dfcfc19a79d47584673a0019c1b26853f7f0ad5dbfffc2bd034e49ec6431d48f62a5f5d8fdf289cf7bd85d6947000a09c425abf5173ff458df1370c25d1c58105c0f90120948bb2361bbb59c5956af2e4dee2b58dd202c606c1f90108a0b34209a263f6c38fe55f099e9e70f9d67e93982480ff3234a5e0108028ad164da00000000000000000000000000000000000000000000000000000000000000008a0000000000000000000000000000000000000000000000000000000000000000ca00000000000000000000000000000000000000000000000000000000000000006a00000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000000000000000000000000000000000000000000ba00000000000000000000000000000000000000000000000000000000000000000f89b947005d9011f4275747d5cb38bc3deb0c46edbd105f884a06bbf63ccc812c3ad4bec82b4209118e1239e429c0ba7c2aca420e00287fa2015a00000000000000000000000000000000000000000000000000000000000000009a06942ba31261b4ea908b20da7f5f671739ed0c2c64c2734c568e854f201695cfea0673570b40957923f91074adc6d929e96d828357821580dfcfc19a79d4758467380a097d0a254d8e9f8bc5f872c969dc753ba729429f57a8bcc53b118bb4a46a37aeaa00fcc127e4b9b1062c948737eb682a89b07e9e99be6393f8dfbf1f42f0dbfb0dc";
  const shortTransactionRaw =
    "0x02f901330182c27c84ee6b28008501f291b8fe83055730941758edff3b5f072f5aca18dadbacf0ab8934264080b8c4cc0e7607647d3d8851658efb5fcb5410bd468ddca239699c00000000000000000000000000000000000000000000000000000000000000000000000020dff257b8828fb8000000000000000000000000000000000000000000026bf962579b98ecf0c23a0000000000000000000000000000000000000000001f304af03a6a56456fe92c000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000630b1c49c080a045d386c3a20c19afae4ae72e49f65574946225249058f87fa62eeb4f4d0ee4ada04f9fab1e1cf0c49512ab3d868e0af1f42bc976e6d3ad8ea0133b734f353c45db";
  for (const {numTransaction} of testCases) {
    const executionPayload: bellatrix.ExecutionPayload = {...seedExecutionPayload};
    executionPayload.transactions = [];
    for (let i = 0; i < numTransaction; i++) {
      if (i % 5 === 0) {
        executionPayload.transactions.push(fromHexString(longTransactionRaw));
      } else {
        executionPayload.transactions.push(fromHexString(shortTransactionRaw));
      }
    }

    itBench({
      id: `${numTransaction} transactions`,
      beforeEach: () => executionPayload,
      fn: (executionPayload) => {
        const serializedExecutionPayload = serializeExecutionPayload(executionPayload);
        JSON.stringify(serializedExecutionPayload);
      },
      runsFactor: 100,
    });
  }
});
